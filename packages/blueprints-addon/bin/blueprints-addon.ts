#!/usr/bin/env node
'use strict';

import yargs from 'yargs';
import { hideBin } from 'yargs/helpers';

import { runDestroy, runGenerate, runNew } from '../src/index.js';

// Provide a title to the process in `ps`
process.title = 'blueprints-addon';

// Set codemod options
yargs(hideBin(process.argv))
  .command({
    aliases: ['d'],
    builder: (yargs) => {
      return yargs
        .positional('blueprint', {
          choices: [
            'component',
            'helper',
            'modifier',
            'service',
            'util',
          ] as const,
          demandOption: true,
          describe: 'Entity type',
          type: 'string',
        })
        .positional('name', {
          demandOption: true,
          describe: 'Entity name',
          type: 'string',
        })
        .option('root', {
          describe: 'Where to run the codemod',
          type: 'string',
        });
    },
    command: 'destroy [blueprint] [name]',
    describe: 'Destroys code generated by `generate` command.',
    handler: (argv) => {
      const codemodOptions = {
        blueprint: argv['blueprint'],
        name: argv['name'],
        projectRoot: argv['root'] ?? process.cwd(),
      };

      runDestroy(codemodOptions);
    },
  })
  .command({
    aliases: ['g'],
    builder: (yargs) => {
      return yargs
        .positional('blueprint', {
          choices: [
            'component',
            'helper',
            'modifier',
            'service',
            'util',
          ] as const,
          demandOption: true,
          describe: 'Entity type',
          type: 'string',
        })
        .positional('name', {
          demandOption: true,
          describe: 'Entity name',
          type: 'string',
        })
        .option('root', {
          describe: 'Where to run the codemod',
          type: 'string',
        });
    },
    command: 'generate [blueprint] [name]',
    describe: 'Generates new code from blueprints.',
    handler: (argv) => {
      const codemodOptions = {
        blueprint: argv['blueprint'],
        name: argv['name'],
        projectRoot: argv['root'] ?? process.cwd(),
      };

      runGenerate(codemodOptions);
    },
  })
  .command({
    builder: (yargs) => {
      return yargs
        .option('location', {
          demandOption: true,
          describe: "Location of the addon (e.g. 'ui/button')",
          type: 'string',
        })
        .option('name', {
          demandOption: true,
          describe: "Name of the addon (e.g. '@my-org-ui/button')",
          type: 'string',
        })
        .option('root', {
          describe: 'Where to run the codemod',
          type: 'string',
        });
    },
    command: 'new',
    describe: 'Creates a v2 addon.',
    handler: (argv) => {
      const codemodOptions = {
        location: argv['location'],
        name: argv['name'],
        projectRoot: argv['root'] ?? process.cwd(),
      };

      runNew(codemodOptions);
    },
  })
  .demandCommand()
  .parseSync();
